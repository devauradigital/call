<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VideoMeet - Video Calling App</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.1/socket.io.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* ... (keep all your existing CSS styles) ... */
    </style>
</head>
<body>
    <!-- ... (keep all your existing HTML) ... -->

    <script>
        const socket = io('https://sedate-helix-blender.glitch.me');
        let localStream, peerConnection;
        let isMuted = false;
        let isVideoOff = false;
        let currentRoomId = '';
        const configuration = {
            iceServers: [{ urls: 'stun:stun.l.google.com:19302' }]
        };

        // Theme management
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            const isDark = document.body.classList.contains('dark-theme');
            localStorage.setItem('darkTheme', isDark);
            
            const icon = document.querySelector('.btn-theme-toggle i');
            icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
            
            showNotification(isDark ? 'Dark theme enabled' : 'Light theme enabled');
        }

        // Check for saved theme preference on load
        document.addEventListener('DOMContentLoaded', () => {
            if (localStorage.getItem('darkTheme') === 'true') {
                document.body.classList.add('dark-theme');
                const icon = document.querySelector('.btn-theme-toggle i');
                icon.className = 'fas fa-sun';
            }
        });

        // Home screen functions
        function createRoom() {
            currentRoomId = generateRoomId();
            document.getElementById('room-id-display').textContent = currentRoomId;
            socket.emit('create-room', currentRoomId);
            startVideoCall(currentRoomId, true);
            
            showNotification(`Meeting created! ID: ${currentRoomId}`);
        }

        function showJoinRoom() {
            document.getElementById('join-room-input').style.display = 'block';
        }

        function joinRoom() {
            currentRoomId = document.getElementById('join-room-id').value.trim();
            const roomIdRegex = /^[0-9a-f]{4}-[0-9a-f]{4}$/;
            if (!roomIdRegex.test(currentRoomId)) {
                showNotification('Invalid Meeting ID format. Use xxxx-xxxx', 'error');
                return;
            }
            document.getElementById('room-id-display').textContent = currentRoomId;
            socket.emit('join-room', currentRoomId);
            startVideoCall(currentRoomId, false);
        }

        // Video call functions
        async function startVideoCall(roomId, isCreator) {
            try {
                document.getElementById('home-screen').style.display = 'none';
                document.getElementById('video-call-screen').style.display = 'block';
                
                // Get user media
                localStream = await navigator.mediaDevices.getUserMedia({ 
                    video: true, 
                    audio: true 
                }).catch(error => {
                    throw new Error(`Failed to get user media: ${error.message}`);
                });
                
                document.getElementById('local-video').srcObject = localStream;
                document.getElementById('no-user-message').style.display = 'block';

                // Initialize peer connection
                peerConnection = new RTCPeerConnection(configuration);

                // Add local stream tracks to connection
                localStream.getTracks().forEach(track => {
                    peerConnection.addTrack(track, localStream);
                });

                // When remote stream is received
                peerConnection.ontrack = event => {
                    console.log('Received remote stream:', event.streams);
                    if (event.streams[0]) {
                        document.getElementById('remote-video').srcObject = event.streams[0];
                        document.getElementById('no-user-message').style.display = 'none';
                    } else {
                        console.warn('No remote stream received');
                    }
                };

                // ICE candidate handling
                peerConnection.onicecandidate = event => {
                    if (event.candidate) {
                        socket.emit('ice-candidate', { 
                            roomId: currentRoomId, 
                            candidate: event.candidate 
                        });
                    }
                };

                // Handle signaling events
                socket.on('user-joined', async () => {
                    if (peerConnection && isCreator) {
                        try {
                            const offer = await peerConnection.createOffer();
                            await peerConnection.setLocalDescription(offer);
                            socket.emit('offer', { roomId: currentRoomId, offer });
                            showNotification('A participant has joined the meeting!');
                        } catch (error) {
                            console.error('Error creating offer on user-joined:', error);
                            showNotification('Error connecting to participant', 'error');
                        }
                    }
                });

                socket.on('offer', async ({ offer, roomId }) => {
                    if (!isCreator) {
                        try {
                            await peerConnection.setRemoteDescription(new RTCSessionDescription(offer));
                            const answer = await peerConnection.createAnswer();
                            await peerConnection.setLocalDescription(answer);
                            socket.emit('answer', { roomId, answer });
                        } catch (error) {
                            console.error('Error handling offer:', error);
                            showNotification('Error establishing connection', 'error');
                        }
                    }
                });

                socket.on('answer', async ({ answer }) => {
                    try {
                        await peerConnection.setRemoteDescription(new RTCSessionDescription(answer));
                    } catch (error) {
                        console.error('Error handling answer:', error);
                        showNotification('Error establishing connection', 'error');
                    }
                });

                socket.on('ice-candidate', async ({ candidate }) => {
                    try {
                        await peerConnection.addIceCandidate(new RTCIceCandidate(candidate));
                    } catch (error) {
                        console.error('Error handling ICE candidate:', error);
                    }
                });

                socket.on('user-disconnected', () => {
                    document.getElementById('no-user-message').style.display = 'block';
                    document.getElementById('no-user-message').textContent = 'Participant has left the meeting';
                    document.getElementById('remote-video').srcObject = null;
                });

                // If creator, create initial offer
                if (isCreator) {
                    const offer = await peerConnection.createOffer();
                    await peerConnection.setLocalDescription(offer);
                    socket.emit('offer', { roomId, offer });
                    console.log('Offer created and sent for room:', roomId);
                }
            } catch (error) {
                console.error('Error starting video call:', error);
                showNotification(`Error starting video call: ${error.message}`, 'error');
                endCall();
            }
        }

        // Call control functions
        function toggleMute() {
            const audioTracks = localStream.getAudioTracks();
            audioTracks.forEach(track => {
                track.enabled = !track.enabled;
            });
            isMuted = !isMuted;
            
            const muteBtn = document.querySelector('.control-btn.mute');
            muteBtn.innerHTML = isMuted ? '<i class="fas fa-microphone-slash"></i>' : '<i class="fas fa-microphone"></i>';
            muteBtn.style.backgroundColor = isMuted ? 'var(--danger-color)' : 'var(--warning-color)';
            
            showNotification(isMuted ? 'Microphone muted' : 'Microphone unmuted');
        }

        function toggleVideo() {
            const videoTracks = localStream.getVideoTracks();
            videoTracks.forEach(track => {
                track.enabled = !track.enabled;
            });
            isVideoOff = !isVideoOff;
            
            const videoBtn = document.querySelector('.control-btn.video-off');
            videoBtn.innerHTML = isVideoOff ? '<i class="fas fa-video-slash"></i>' : '<i class="fas fa-video"></i>';
            videoBtn.style.backgroundColor = isVideoOff ? 'var(--danger-color)' : 'var(--dark-color)';
            
            showNotification(isVideoOff ? 'Video turned off' : 'Video turned on');
        }

        function endCall() {
            if (peerConnection) {
                peerConnection.close();
            }
            if (localStream) {
                localStream.getTracks().forEach(track => track.stop());
            }
            
            socket.emit('leave-room', currentRoomId);
            
            document.getElementById('home-screen').style.display = 'flex';
            document.getElementById('video-call-screen').style.display = 'none';
            document.getElementById('join-room-input').style.display = 'none';
            document.getElementById('remote-video').srcObject = null;
            document.getElementById('local-video').srcObject = null;
            
            // Reset controls
            isMuted = false;
            isVideoOff = false;
        }

        // Utility functions
        function generateRoomId() {
            return 'xxxx-xxxx'.replace(/x/g, () => Math.floor(Math.random() * 16).toString(16));
        }

        function copyRoomId() {
            navigator.clipboard.writeText(currentRoomId);
            showNotification('Meeting ID copied to clipboard!');
        }

        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.classList.add('fade-out');
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // Handle room errors
        socket.on('room-error', (message) => {
            showNotification(message, 'error');
            document.getElementById('home-screen').style.display = 'flex';
            document.getElementById('video-call-screen').style.display = 'none';
        });

        // Handle mobile device orientation changes
        window.addEventListener('orientationchange', () => {
            if (window.orientation === 90 || window.orientation === -90) {
                document.getElementById('local-video').style.width = '15%';
            } else {
                document.getElementById('local-video').style.width = '20%';
            }
        });
    </script>
</body>
</html>
